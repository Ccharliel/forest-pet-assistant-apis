<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- 微信专用meta标签 -->
    <meta name="x5-fullscreen" content="true">
    <meta name="full-screen" content="yes">
    <meta name="x5-page-mode" content="app">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>监控直播</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        #player {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="loading">加载中...</div>
    <div id="player-container"></div>

    <script>
        // 1. 从URL获取参数 ?hlsAddress=xxx
        const urlParams = new URLSearchParams(window.location.search);
        const hlsAddressParam = urlParams.get('hlsAddress');

        // 2. 必须从参数获取HLS地址，没有参数就报错
        if (!hlsAddressParam) {
            document.getElementById('loading').innerHTML = '错误：未提供HLS流地址<br>请通过正确的链接访问';
            throw new Error('未提供hlsAddress参数');
        }

        // 3. 解码得到真实的HLS地址
        const HLS_URL = decodeURIComponent(hlsAddressParam);
        console.log('从URL参数获取到HLS地址:', HLS_URL);

        // 检测是否在微信中
        const ua = navigator.userAgent.toLowerCase();
        const isWeChat = ua.indexOf('micromessenger') > -1;
        const isIOS = /iphone|ipad|ipod/.test(ua);

        console.log('UserAgent:', ua);
        console.log('是否微信:', isWeChat);
        console.log('是否iOS:', isIOS);

        function initPlayer() {
            const loading = document.getElementById('loading');

            if (isWeChat) {
                console.log('使用微信专用播放方案');

                // 方案1：使用腾讯云播放器SDK（新版）
                const script = document.createElement('script');
                script.src = 'https://web-player.qcloud.com/vod/sdk-v3/release/sdk-v3.1.0.js';
                script.onload = function() {
                    try {
                        const player = new TcPlayer('player-container', {
                            'm3u8': HLS_URL,
                            'autoplay': true,
                            'width': '100%',
                            'height': '100%',
                            'live': true,
                            'controls': 'auto',
                            'x5_type': 'h5',
                            'x5_fullscreen': true,
                            'x5_video_position': 'center',
                            'wechat_type': 'video',
                            'playsinline': true,
                            'preload': 'auto',
                            'fluid': true,
                            'fill': true
                        });

                        player.on('ready', function() {
                            console.log('腾讯播放器准备就绪');
                            loading.style.display = 'none';
                        });

                        player.on('error', function(err) {
                            console.error('腾讯播放器错误:', err);
                            fallbackToHlsJS();
                        });

                    } catch (error) {
                        console.error('腾讯播放器初始化失败:', error);
                        fallbackToHlsJS();
                    }
                };
                script.onerror = fallbackToHlsJS;
                document.head.appendChild(script);

            } else {
                // 非微信环境用hls.js + video元素
                console.log('使用标准HLS播放');
                fallbackToHlsJS();
            }
        }

        // 备用方案：hls.js
        function fallbackToHlsJS() {
            console.log('切换到hls.js备用方案');
            const loading = document.getElementById('loading');

            // 加载hls.js
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/hls.js@1.4.10/dist/hls.min.js';
            script.onload = function() {
                const container = document.getElementById('player-container');
                container.innerHTML = '';

                const video = document.createElement('video');
                video.id = 'player';
                video.controls = true;
                video.autoplay = true;
                video.playsinline = true;
                video.webkitPlaysinline = true; // iOS专用
                video.x5Playsinline = true; // 微信X5内核专用
                video.style.width = '100%';
                video.style.height = '100%';
                video.muted = true; // iOS需要静音才能自动播放

                container.appendChild(video);

                if (Hls.isSupported()) {
                    console.log('HLS.js 支持此浏览器');
                    const hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90,
                        manifestLoadingMaxRetry: 5,
                        manifestLoadingRetryDelay: 500,
                        manifestLoadingMaxRetryTimeout: 10000,
                        startLevel: -1,
                    });

                    hls.loadSource(HLS_URL);
                    hls.attachMedia(video);

                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        console.log('HLS流加载成功');
                        loading.style.display = 'none';
                        // iOS需要用户交互才能播放，这里先静音播放
                        video.muted = true;
                        video.play().catch(e => {
                            console.log('自动播放失败，需要用户点击:', e);
                            // 显示点击提示
                            loading.innerHTML = '点击屏幕开始播放';
                            loading.style.display = 'block';
                            loading.onclick = function() {
                                video.play();
                                loading.style.display = 'none';
                            };
                        });
                    });

                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLS错误:', data);
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.error('网络错误，尝试重连...');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.error('媒体错误，尝试恢复...');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    console.error('无法恢复的错误');
                                    loading.innerHTML = '播放失败，请刷新重试';
                                    break;
                            }
                        }
                    });

                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    // iOS Safari 原生支持
                    console.log('浏览器原生支持HLS');
                    video.src = HLS_URL;
                    video.addEventListener('loadedmetadata', function() {
                        loading.style.display = 'none';
                        video.play().catch(e => {
                            console.log('iOS自动播放失败:', e);
                            loading.innerHTML = '点击屏幕开始播放';
                            loading.style.display = 'block';
                        });
                    });
                } else {
                    loading.innerHTML = '您的浏览器不支持视频播放';
                }
            };
            script.onerror = function() {
                loading.innerHTML = '加载播放器失败';
            };
            document.head.appendChild(script);
        }

        // 微信特殊处理
        if (isWeChat) {
            // 监听微信JSBridge准备就绪
            document.addEventListener('WeixinJSBridgeReady', function() {
                console.log('微信JSBridge已就绪');
                initPlayer();
            }, false);

            // 如果微信JSBridge已经就绪
            if (window.WeixinJSBridge && WeixinJSBridge.invoke) {
                initPlayer();
            } else {
                // 3秒后如果还没就绪，直接初始化
                setTimeout(initPlayer, 3000);
            }
        } else {
            // 非微信直接初始化
            initPlayer();
        }

        // 全局点击事件处理（iOS自动播放）
        document.addEventListener('click', function() {
            const video = document.getElementById('player');
            if (video && video.paused) {
                video.play().catch(e => console.log('点击播放失败:', e));
            }
        }, { once: true });

    </script>
</body>
</html>